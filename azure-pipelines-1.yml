trigger:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'



stages:
  - stage: BuildDocker
    displayName: 'Build Docker Image'
    jobs:
      - job: Build
        displayName: 'Docker Build and Push'
        steps:
          - task: Docker@2
            inputs:
              containerRegistry: 'DockerHubRegistry'
              repository: '$(DOCKER_USERNAME)/chancetek_devops'
              command: 'build'
              Dockerfile: '**/Dockerfile'
              tags: |
                latest
                $(Build.BuildId)

          - task: Docker@2
            displayName: 'Push Docker Image to Docker Hub'
            inputs:
              containerRegistry: 'DockerHubRegistry'
              repository: '$(DOCKER_USERNAME)/chancetek_devops'
              command: 'push'
              tags: |
                latest
                $(Build.BuildId)

  - stage: ScanImage
    displayName: 'Scan Docker Image with Trivy'
    dependsOn: BuildDocker
    jobs:
      - job: Scan
        displayName: 'Run Trivy Image Scan'
        steps:
          # Test if Docker is installed and working
          - script: |
              echo "Testing Docker installation..."
              docker --version
              if [ $? -ne 0 ]; then
                echo "Docker is not installed. Exiting."
                exit 1
              fi
            displayName: 'Test Docker Availability'

          # Log in to Docker Hub and pull the image for scanning
          - script: |
              echo "Logging in to Docker Hub..."
              echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
              docker pull $(DOCKER_USERNAME)/chancetek_devops
            displayName: 'Login to Docker and Pull Image'

          # Install Trivy for scanning
          - script: |
              echo "Installing Trivy..."
              sudo apt-get update -y
              sudo apt-get install -y wget
              wget https://github.com/aquasecurity/trivy/releases/latest/download/trivy_0.41.0_Linux-64bit.deb
              sudo dpkg -i trivy_0.41.0_Linux-64bit.deb
              trivy --version
              if [ $? -ne 0 ]; then
                echo "Trivy installation failed. Exiting."
                exit 1
              fi
            displayName: 'Install and Verify Trivy'

          # Run Trivy scan
          - script: |
              echo "Running Trivy scan..."
              trivy image $(DOCKER_USERNAME)/chancetek_devops
            displayName: 'Docker Scan with Trivy'


  # TestApp stage depends on ScanImage stage completion
  - stage: TestApp
    displayName: 'Run Selenium Tests'
    dependsOn: 
      - ScanImage  # Ensure ScanImage stage is completed first
    jobs:
      - job: Test
        displayName: 'Run Selenium Tests'
        steps:
          - script: |
              # Command to start the app or run Selenium tests
              python -m pytest tests/
            displayName: 'Run Selenium Tests'




